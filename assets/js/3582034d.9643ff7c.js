"use strict";(self.webpackChunkdocs_firefish=self.webpackChunkdocs_firefish||[]).push([[3470],{339:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"firefish-protocol","title":"Firefish Protocol","description":"This document outlines the technical design of the Firefish Protocol. Please note that the actual implementation\u2014delivered through the Firefish application\u2014may differ in certain aspects, as both the application and the underlying escrow system remain under active development. For the most accurate and up-to-date information on the current functionality and limitations of the Firefish Protocol, please refer to the Terms of Service.","source":"@site/docs/firefish-protocol.md","sourceDirName":".","slug":"/firefish-protocol","permalink":"/docs-Firefish/docs/firefish-protocol","draft":false,"unlisted":false,"editUrl":"https://github.com/Anananas42/docs-Firefish/tree/main/docs/firefish-protocol.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docSidebar","previous":{"title":"Firefish Protocol","permalink":"/docs-Firefish/docs/faq/protocol"},"next":{"title":"Media & Insights","permalink":"/docs-Firefish/docs/media-insights"}}');var i=r(4848),o=r(8453);const s={sidebar_position:3},a="Firefish Protocol",c={},l=[{value:"Subjects of Firefish Protocol",id:"subjects-of-firefish-protocol",level:2},{value:"Escrow Contract",id:"escrow-contract",level:2},{value:"Prefund Contract",id:"prefund-contract",level:2},{value:"Protocol Implementation",id:"protocol-implementation",level:2},{value:"The Process",id:"the-process",level:2},{value:"Key Benefits of Firefish Protocol",id:"key-benefits-of-firefish-protocol",level:2},{value:"Potential Drawbacks of Firefish Protocol",id:"potential-drawbacks-of-firefish-protocol",level:2}];function d(e){const t={a:"a",admonition:"admonition",blockquote:"blockquote",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"firefish-protocol",children:"Firefish Protocol"})}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:["This document outlines the technical design of the Firefish Protocol. Please note that the actual implementation\u2014delivered through the Firefish application\u2014may differ in certain aspects, as both the application and the underlying escrow system remain under active development. For the most accurate and up-to-date information on the current functionality and limitations of the Firefish Protocol, please refer to the ",(0,i.jsx)(t.a,{href:"/docs/legal/terms-of-service",children:"Terms of Service"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.admonition,{title:"Key Features",type:"info",children:[(0,i.jsx)(t.p,{children:"\ud83d\udd25 The Firefish Protocol enables the escrow of Bitcoin for peer-to-peer collateralized loans settled in fiat currency"}),(0,i.jsx)(t.p,{children:"\ud83d\udd25 The protocol uses the scripting capabilities of bitcoin, such as multi-signature schemes and Partially Signed Bitcoin Transactions (PSBT)"}),(0,i.jsx)(t.p,{children:"\ud83d\udd25 The goal of the protocol is to remove risk and trust requirements from the interaction between parties"})]}),"\n",(0,i.jsx)(t.h2,{id:"subjects-of-firefish-protocol",children:"Subjects of Firefish Protocol"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Borrower:"})," An individual or entity that owns bitcoin and seeks fiat liquidity."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Lender:"})," An individual or entity that has excess fiat liquidity and wants to earn interest."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Liquidator:"})," An entity entrusted by the Lender to liquidate the collateral in its name in the event that the Borrower does not fulfill its obligations. The Lender can also act as the Liquidator themselves."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Price Oracle:"})," An Oracle that attests to the exchange rate of bitcoin. It can be implemented as a trusted institution, a public oracle, or a threshold of institutions and public oracles. Price Oracle is currently operated by Firefish."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Payment Oracle:"})," An Oracle that attests to whether or not a fiat payment has been made (e.g. loan repayment). Payment Oracle is currently operated by Firefish."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Firefish:"})," A platform that matches Borrowers and Lenders and facilitates their secure interaction."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"escrow-contract",children:"Escrow Contract"}),"\n",(0,i.jsx)(t.p,{children:"The escrow contract is a central part of the Firefish Protocol. It allows to lock bitcoin collateral on a specific address, and further actions with the collateral are only possible:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"When certain conditions are met (such as loan repayment)"}),"\n",(0,i.jsx)(t.li,{children:"In a specific way (the contract output can only be directed to predetermined addresses)"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"The escrow contract can be schematically represented as follows:"}),"\n",(0,i.jsx)(t.p,{children:"The first layer of the escrow contract is the tx_escrow transaction. Its input is the Borrower's UTXO (Borrower's bitcoin) and its output is a 3-of-3 multisig, with keys held by:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"The Price Oracle"}),"\n",(0,i.jsx)(t.li,{children:"The Payment Oracle"}),"\n",(0,i.jsx)(t.li,{children:"The Borrower (ephemeral key), B-EPH"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"The output of the tx_escrow transaction represents the escrow itself, and this is where the bitcoin is held during the loan."}),"\n",(0,i.jsx)(t.p,{children:"The second layer of the escrow contract is represented by set of partially signed transactions (PSBTs) that allow the output of the tx_escrow to be spent, i.e the collateral to be unlocked and sent to a predetermined address. This occurs when certain conditions are met (such as loan repayment) and the missing signatures are added to a PSBT."}),"\n",(0,i.jsx)(t.p,{children:"The possible states of the escrow contract, represented by individual PSBTs, are:"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Contract state"}),(0,i.jsx)(t.th,{children:"PSBT used"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{children:"Missing signature"}),(0,i.jsx)(t.th,{children:"Output to"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Repayment"}),(0,i.jsx)(t.td,{children:"tx_repayment"}),(0,i.jsx)(t.td,{children:"Loan fully repaid on due date"}),(0,i.jsx)(t.td,{children:"Payment Oracle"}),(0,i.jsx)(t.td,{children:"Borrower -B"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Default"}),(0,i.jsx)(t.td,{children:"tx_default"}),(0,i.jsx)(t.td,{children:"Borrower failed to repay"}),(0,i.jsx)(t.td,{children:"Payment Oracle"}),(0,i.jsx)(t.td,{children:"Liquidator"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Liquidation"}),(0,i.jsx)(t.td,{children:"tx_liquidation"}),(0,i.jsx)(t.td,{children:"Insufficient collateral value"}),(0,i.jsx)(t.td,{children:"Price Oracle, Payment Oracle"}),(0,i.jsx)(t.td,{children:"Liquidator"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Cancellation"}),(0,i.jsx)(t.td,{children:"tx_repayment"}),(0,i.jsx)(t.td,{children:"Lender did not provide loan funds at all"}),(0,i.jsx)(t.td,{children:"Payment Oracle"}),(0,i.jsx)(t.td,{children:"Borrower -B"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"Recovery"}),(0,i.jsx)(t.td,{children:"tx_recover"}),(0,i.jsx)(t.td,{children:"If Oracles or Platform do not cooperate or cease to exist, Borrower can recover the collateral after given timelock without interaction to other party"}),(0,i.jsx)(t.td,{children:"none, timelock is used"}),(0,i.jsx)(t.td,{children:"Borrower -B"})]})]})]}),"\n",(0,i.jsxs)(t.admonition,{title:"Key Management",type:"info",children:[(0,i.jsx)(t.p,{children:"The Borrower uses two types of keys within the protocol:"}),(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"B"})," represents a key pair fully controlled by the Borrower (such as stored on a hardware wallet). All outputs of the escrow designated for the Borrower are directed here."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"B-EPH"})," represents an ephemeral key pair created in the Firefish app and used for signing during the contract setup. The keys are not needed after the setup is complete and are deleted."]}),"\n"]})]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"All PSBTs are intended to be pre-signed before the tx_escrow transaction is broadcast by the Borrower, and the escrow is funded. This allows the Borrower to have control over all possible ways that the escrow contract can be spent."}),"\n",(0,i.jsx)(t.li,{children:"In order to construct a transaction, you must know its inputs and outputs."}),"\n",(0,i.jsx)(t.li,{children:"In this context, to construct the tx_escrow and PSBTs, you need to know the inputs of the tx_escrow, which are the Borrower's unspent UTXOs that they wish to use as collateral."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"prefund-contract",children:"Prefund Contract"}),"\n",(0,i.jsx)(t.p,{children:"To make it practical for Borrowers who use a variety of bitcoin infrastructure (hardware wallets, software wallets, custodial wallets), we propose using an extra on-chain transaction to consolidate and acknowledge the UTXOs that will be used to fund the escrow contract."}),"\n",(0,i.jsx)(t.p,{children:"The extra on-chain transaction, called prefund transaction (tx_prefund), precedes the escrow transaction and can be schematically depicted as follows:"}),"\n",(0,i.jsx)(t.p,{children:"TODO"}),"\n",(0,i.jsx)(t.p,{children:"This construct makes it easy for Borrowers to interact with the Firefish protocol. First, they send their bitcoin collateral to a specific prefund address (A_prefund), which allows to create the follow-up escrow and closing transactions."}),"\n",(0,i.jsx)(t.p,{children:"The prefund address represents the following spending condition:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"3-of-3 multisig (Borrower\u2019s prefund key, Price Oracle, Payment Oracle), or"}),"\n",(0,i.jsx)(t.li,{children:"Borrower\u2019s prefund key and a relative timelock of 7 days"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"The first spending condition using the multisig is used to move bitcoin from prefund to escrow when all parties cooperate.\nThe second spending condition using only Borrower\u2019s prefund key with a relative timelock works as a safeguard for the Borrower, should oracles become unresponsive or malicious during the contract setup."}),"\n",(0,i.jsx)(t.p,{children:"Once the Bitcoin is locked into prefund, all information is known to create the escrow and closing transactions."}),"\n",(0,i.jsx)(t.h2,{id:"protocol-implementation",children:"Protocol Implementation"}),"\n",(0,i.jsxs)(t.p,{children:["The whole Firefish protocol is implemented in Rust. To simplify the interaction with the protocol for Borrowers, the Borrower's part, called borrower-client, is compiled into WASM and runs at app.firefish.io. The source code for the borrower-client is available HERE. It also contains instructions for deterministic builds, allowing Borrowers to verify that the client used at ",(0,i.jsx)(t.a,{href:"https://app.firefish.io",children:"Firefish"})," corresponds to the published source code."]}),"\n",(0,i.jsx)(t.h2,{id:"the-process",children:"The Process"}),"\n",(0,i.jsx)(t.p,{children:"Below you can find the simplified process of the escrow setup and the lifetime of the loan."}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"The participants in the protocol securely exchange necessary data (such as loan details) and public keys."}),"\n",(0,i.jsx)(t.li,{children:"Borrower enters his return address where bitcoin collateral will be returned upon successful repayment"}),"\n",(0,i.jsx)(t.li,{children:"Using the borrower-client, the Borrower generates the prefund address"}),"\n",(0,i.jsx)(t.li,{children:"The Borrower sends bitcoin collateral to the prefund address using their own wallet."}),"\n",(0,i.jsx)(t.li,{children:"Using the borrower-client, the Borrower constructs the escrow and closing transactions, and adds their own signatures to the closing transactions."}),"\n",(0,i.jsx)(t.li,{children:"The oracles add their own signatures to the escrow transaction and the closing transactions according to the protocol specification."}),"\n",(0,i.jsx)(t.li,{children:"Using the borrower-client, the Borrower verifies that all transactions and signatures are in place. After verification, Borrower adds the last missing signature to the escrow transaction."}),"\n",(0,i.jsx)(t.li,{children:"Using the borrower-client, the Borrower discards their escrow private key, ensuring that the spending options for the escrow are limited to those defined by the closing transactions."}),"\n",(0,i.jsx)(t.li,{children:"Borrower broadcasts the now fully signed escrow transaction, effectively locking bitcoin collateral. The escrow is properly set."}),"\n",(0,i.jsx)(t.li,{children:"Lender sends funds (fiat or stablecoins) to the Borrower."}),"\n",(0,i.jsx)(t.li,{children:"Later, when the loan outcome is known (repayment, default, \u2026), the corresponding transaction is signed and broadcast by the responsible oracle for the given outcome."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"key-benefits-of-firefish-protocol",children:"Key Benefits of Firefish Protocol"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"The escrow has a \"deterministic\" nature. It can only be spent on the Borrower's or Lender\u2019s/Liquidator's address, but not to any other subject."}),"\n",(0,i.jsx)(t.li,{children:"The Lender does not need to possess any cryptographic material or otherwise interact with the Bitcoin network. This allows entities that are not Bitcoin-native to invest on the Firefish platform."}),"\n",(0,i.jsx)(t.li,{children:"The Borrower only needs to be online and interact with the platform during the escrow setup phase. Afterwards, this is no longer necessary - they do not need to sign anything else or keep the keys online."}),"\n",(0,i.jsx)(t.li,{children:"If the Oracles stop cooperating during any phase of the loan, the Borrower can spend the Bitcoin on their own address after the timelock expires."}),"\n",(0,i.jsx)(t.li,{children:"The interaction of the Borrower with the protocol is reduced to (i) provide your return address and (ii) send bitcoin to the prefund address. The whole complexity, such as creating the addresses and signing the escrow and closing transactions, is processed by the borrower-client."}),"\n",(0,i.jsx)(t.li,{children:"Since the interaction is so simple, Firefish can be used by hardware wallet owners as well as Multi-Party Computation (MPC) wallets (institutions) or even custodial solutions (which is indeed not recommended)."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"potential-drawbacks-of-firefish-protocol",children:"Potential Drawbacks of Firefish Protocol"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"As with any other bitcoin-backed lending protocol, some level of trust is required in the Oracles being honest. However, we believe that this need for trust can be minimized at the implementation level (for example, decentralizing the Price oracle, using DLCs, anonymization techniques used by the Payment oracle, etc.)."}),"\n",(0,i.jsx)(t.li,{children:"The contract cannot be canceled without the cooperation of the Oracle entities, even if the Lender and Borrower agree."}),"\n",(0,i.jsx)(t.li,{children:"The complexity of the proposed solution and the fact that the security and business advantages may not be immediately apparent."}),"\n",(0,i.jsx)(t.li,{children:"The Lender (and Borrower) must have some level of trust in the Liquidator that they will return the funds/bitcoin in the case of liquidation and default. This can be minimized, for example, by the Liquidator providing some form of security or using DLCs."}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>s,x:()=>a});var n=r(6540);const i={},o=n.createContext(i);function s(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);