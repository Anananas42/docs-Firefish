"use strict";(self.webpackChunkdocs_firefish=self.webpackChunkdocs_firefish||[]).push([[3470],{3988:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"firefish-protocol","title":"Firefish Protocol","description":"This document outlines the technical design of the Firefish Protocol. Please note that the actual implementation\u2014delivered through the Firefish application\u2014may differ in certain aspects, as both the application and the underlying escrow system remain under active development. For the most accurate and up-to-date information on the current functionality and limitations of the Firefish Protocol, please refer to the Terms of Service.","source":"@site/docs/firefish-protocol.md","sourceDirName":".","slug":"/firefish-protocol","permalink":"/docs-Firefish/docs/firefish-protocol","draft":false,"unlisted":false,"editUrl":"https://github.com/Anananas42/docs-Firefish/tree/main/docs/firefish-protocol.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docSidebar","previous":{"title":"Firefish Protocol","permalink":"/docs-Firefish/docs/faq/protocol"},"next":{"title":"Media & Insights","permalink":"/docs-Firefish/docs/media-insights"}}');var n=r(4848),s=r(8453);const o={sidebar_position:3},a="Firefish Protocol",c={},l=[{value:"Subjects of Firefish Protocol",id:"subjects-of-firefish-protocol",level:2},{value:"Escrow Contract",id:"escrow-contract",level:2},{value:"Prefund Contract",id:"prefund-contract",level:2},{value:"Firefish App",id:"firefish-app",level:2},{value:"The Process",id:"the-process",level:2},{value:"Key Benefits of Firefish Protocol",id:"key-benefits-of-firefish-protocol",level:2},{value:"Potential Drawbacks of Firefish Protocol",id:"potential-drawbacks-of-firefish-protocol",level:2}];function h(e){const t={a:"a",admonition:"admonition",blockquote:"blockquote",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"firefish-protocol",children:"Firefish Protocol"})}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsxs)(t.p,{children:["This document outlines the technical design of the Firefish Protocol. Please note that the actual implementation\u2014delivered through the Firefish application\u2014may differ in certain aspects, as both the application and the underlying escrow system remain under active development. For the most accurate and up-to-date information on the current functionality and limitations of the Firefish Protocol, please refer to the ",(0,n.jsx)(t.a,{href:"/docs/legal/terms-of-service",children:"Terms of Service"}),"."]}),"\n"]}),"\n",(0,n.jsxs)(t.admonition,{title:"Key Features",type:"info",children:[(0,n.jsx)(t.p,{children:"\ud83d\udd25 The Firefish Protocol enables the escrow of Bitcoin for peer-to-peer collateralized loans settled in fiat currency"}),(0,n.jsx)(t.p,{children:"\ud83d\udd25 The protocol uses the scripting capabilities of bitcoin, such as multi-signature schemes and Partially Signed Bitcoin Transactions (PSBT)"}),(0,n.jsx)(t.p,{children:"\ud83d\udd25 The goal of the protocol is to remove risk and trust requirements from the interaction between parties"})]}),"\n",(0,n.jsx)(t.h2,{id:"subjects-of-firefish-protocol",children:"Subjects of Firefish Protocol"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Borrower:"})," An individual or entity that owns bitcoin and seeks fiat liquidity."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Lender:"})," An individual or entity that has excess fiat liquidity and wants to earn interest."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Liquidator:"})," An entity entrusted by the Lender to liquidate the collateral in its name in the event that the Borrower does not fulfill its obligations. The Lender can also act as the Liquidator themselves."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Price Oracle:"})," An Oracle that attests to the exchange rate of bitcoin. It can be implemented as a trusted institution, a public oracle, or a threshold of institutions and public oracles. Price Oracle is currently operated by Firefish."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Payment Oracle:"})," An Oracle that attests to whether or not a fiat payment has been made (e.g. loan repayment). Payment Oracle is currently operated by Firefish."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Firefish:"})," A platform that matches Borrowers and Lenders and facilitates their secure interaction."]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"escrow-contract",children:"Escrow Contract"}),"\n",(0,n.jsx)(t.p,{children:"The escrow contract is a central part of the Firefish Protocol. It allows to lock bitcoin collateral on a specific address, and further actions with the collateral are only possible:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"When certain conditions are met (such as loan repayment)"}),"\n",(0,n.jsx)(t.li,{children:"In a specific way (the contract output can only be directed to predetermined addresses)"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The escrow contract can be schematically represented as follows:"}),"\n",(0,n.jsx)(t.p,{children:"The first layer of the escrow contract is the tx_escrow transaction. Its input is the Borrower's UTXO (Borrower's bitcoin) and its output is a 3-of-3 multisig, with keys held by:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"The Price Oracle"}),"\n",(0,n.jsx)(t.li,{children:"The Payment Oracle"}),"\n",(0,n.jsx)(t.li,{children:"The Borrower (ephemeral key), B-EPH"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The output of the tx_escrow transaction represents the escrow itself, and this is where the bitcoin is held during the loan."}),"\n",(0,n.jsx)(t.p,{children:"The second layer of the escrow contract is represented by set of partially signed transactions (PSBTs) that allow the output of the tx_escrow to be spent, i.e the collateral to be unlocked and sent to a predetermined address. This occurs when certain conditions are met (such as loan repayment) and the missing signatures are added to a PSBT."}),"\n",(0,n.jsx)(t.p,{children:"The possible states of the escrow contract, represented by individual PSBTs, are:"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Contract state"}),(0,n.jsx)(t.th,{children:"PSBT used"}),(0,n.jsx)(t.th,{children:"Description"}),(0,n.jsx)(t.th,{children:"Missing signature"}),(0,n.jsx)(t.th,{children:"Output to"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Repayment"}),(0,n.jsx)(t.td,{children:"tx_repayment"}),(0,n.jsx)(t.td,{children:"Loan fully repaid on due date"}),(0,n.jsx)(t.td,{children:"Payment Oracle"}),(0,n.jsx)(t.td,{children:"Borrower -B"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Default"}),(0,n.jsx)(t.td,{children:"tx_default"}),(0,n.jsx)(t.td,{children:"Borrower failed to repay"}),(0,n.jsx)(t.td,{children:"Payment Oracle"}),(0,n.jsx)(t.td,{children:"Liquidator"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Liquidation"}),(0,n.jsx)(t.td,{children:"tx_liquidation"}),(0,n.jsx)(t.td,{children:"Insufficient collateral value"}),(0,n.jsx)(t.td,{children:"Price Oracle, Payment Oracle"}),(0,n.jsx)(t.td,{children:"Liquidator"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Cancellation"}),(0,n.jsx)(t.td,{children:"tx_repayment"}),(0,n.jsx)(t.td,{children:"Lender did not provide loan funds at all"}),(0,n.jsx)(t.td,{children:"Payment Oracle"}),(0,n.jsx)(t.td,{children:"Borrower -B"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Recovery"}),(0,n.jsx)(t.td,{children:"tx_recover"}),(0,n.jsx)(t.td,{children:"If Oracles or Platform do not cooperate or cease to exist, Borrower can recover the collateral after given timelock without interaction to other party"}),(0,n.jsx)(t.td,{children:"none, timelock is used"}),(0,n.jsx)(t.td,{children:"Borrower -B"})]})]})]}),"\n",(0,n.jsxs)(t.admonition,{title:"Key Management",type:"info",children:[(0,n.jsx)(t.p,{children:"The Borrower uses two types of keys within the protocol:"}),(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"B"})," represents a key pair fully controlled by the Borrower (such as stored on a hardware wallet). All outputs of the escrow designated for the Borrower are directed here."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"B-EPH"})," represents an ephemeral key pair created in the Firefish app and used for signing during the contract setup. The keys are not needed after the setup is complete and are deleted."]}),"\n"]})]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"All PSBTs are intended to be pre-signed before the tx_escrow transaction is broadcast by the Borrower, and the escrow is funded. This allows the Borrower to have control over all possible ways that the escrow contract can be spent."}),"\n",(0,n.jsx)(t.li,{children:"In order to construct a transaction, you must know its inputs and outputs."}),"\n",(0,n.jsx)(t.li,{children:"In this context, to construct the tx_escrow and PSBTs, you need to know the inputs of the tx_escrow, which are the Borrower's unspent UTXOs that they wish to use as collateral."}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"prefund-contract",children:"Prefund Contract"}),"\n",(0,n.jsx)(t.p,{children:"To make it practical for Borrowers who use a variety of bitcoin infrastructure (hardware wallets, software wallets, custodial wallets), we propose using an extra on-chain transaction to consolidate and acknowledge the UTXOs that will be used to fund the escrow contract."}),"\n",(0,n.jsx)(t.p,{children:"The extra on-chain transaction, called tx_prefund, precedes the tx_escrow transaction and can be schematically depicted as follows:"}),"\n",(0,n.jsx)(t.p,{children:"This construct makes it easy for Borrowers to interact with the Firefish protocol: they send their bitcoin collateral to a specific address, A_prefund."}),"\n",(0,n.jsx)(t.p,{children:"A_prefund represents a complex spending condition:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"3-of-3 multisig (Borrower's ephemeral key B-EPH, Price Oracle, Payment Oracle)"}),"\n",(0,n.jsx)(t.li,{children:"Signature with Borrower's ephemeral key B-EPH after a given timelock"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The multisig branch is used in the tx_escrow transaction, while the other two options provide additional security and reduce the trust required between parties."}),"\n",(0,n.jsx)(t.h2,{id:"firefish-app",children:"Firefish App"}),"\n",(0,n.jsx)(t.p,{children:"The Firefish protocol is designed to minimize risk and reduce the need for mutual trust between parties. To fully benefit from the security of the prefund and escrow contracts, Borrowers must be able to construct addresses and transactions or verify that they have been correctly implemented according to the protocol."}),"\n",(0,n.jsx)(t.p,{children:"To make the protocol accessible to Borrowers with a range of technical skills and who use different wallets, the Firefish App has been developed. This is a special-purpose bitcoin wallet software that includes the following features:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"The App is (soon to be) open source software that can be compiled and run by the Borrower on their own hardware (desktop or within a web browser)."}),"\n",(0,n.jsx)(t.li,{children:"The App is able to construct complex addresses and transactions according to the Firefish protocol."}),"\n",(0,n.jsx)(t.li,{children:"The App generates ephemeral key pairs, signs transactions, and stores necessary data (such as PSBTs)."}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"the-process",children:"The Process"}),"\n",(0,n.jsx)(t.p,{children:"Below you can find the simplified process of the escrow setup and the lifetime of the loan."}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"The participants in the protocol securely exchange necessary data (such as loan details) and public keys."}),"\n",(0,n.jsx)(t.li,{children:"Using the Firefish App, the Borrower generates A_prefund (and the corresponding locking script)."}),"\n",(0,n.jsx)(t.li,{children:"The Borrower sends bitcoin collateral to A_prefund using their own wallet."}),"\n",(0,n.jsx)(t.li,{children:"Using the Firefish App, the Borrower constructs tx_escrow and PSBTs, and adds their own signatures to the PSBTs."}),"\n",(0,n.jsx)(t.li,{children:"After verification, the Oracles sign tx_escrow and the PSBTs according to the protocol."}),"\n",(0,n.jsx)(t.li,{children:"The Borrower can now verify that all transactions and signatures are in place. After verification, they sign tx_escrow."}),"\n",(0,n.jsx)(t.li,{children:"The Borrower discards the B-EPH key, ensuring that the spending options for the escrow are limited to those defined by the PSBTs."}),"\n",(0,n.jsx)(t.li,{children:"The escrow is properly set."}),"\n",(0,n.jsx)(t.li,{children:"When some event occur during the lifetime of the loan (such as liquidation), the Oracle adds the necessary missing signature to the PSBT and broadcasts it to the network."}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"key-benefits-of-firefish-protocol",children:"Key Benefits of Firefish Protocol"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"The escrow has a \"deterministic\" nature. It can only be spent on the Borrower's or Liquidator's address, but not to any other subject."}),"\n",(0,n.jsx)(t.li,{children:"The Lender does not need to possess any cryptographic material or otherwise interact with the Bitcoin network. This allows entities that are not Bitcoin-native to use the Firefish platform."}),"\n",(0,n.jsx)(t.li,{children:"The Borrower only needs to be online and interact with the platform during the escrow setup phase. Afterwards, this is no longer necessary - they do not need to sign anything else or keep the keys online."}),"\n",(0,n.jsx)(t.li,{children:"If the Oracles stop cooperating during any phase of the loan, the Borrower can spend the Bitcoin on their own address after the timelock expires."}),"\n",(0,n.jsx)(t.li,{children:'The interaction of the Borrower with the protocol can be reduced to two simple steps: 1) provide your "return" address, 2) send the collateral to another address. The complexity, such as signing the PSBT, is processed by the Firefish application. This will be completely open-source and ideally compiled on the Borrower\'s side.'}),"\n",(0,n.jsx)(t.li,{children:"Since the interaction is so simple, Firefish can be used by hardware wallet owners as well as Multi-Party Computation (MPC) wallets (institutions) or even custodial solutions (which is indeed not recommended)."}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"potential-drawbacks-of-firefish-protocol",children:"Potential Drawbacks of Firefish Protocol"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"As with any other crypto lending system, some level of trust is required in the Oracles providing correct data within the Firefish. However, we believe that this need for trust can be minimized at the implementation level (for example, decentralizing the price oracle, using DLCs, anonymization techniques used by the payment oracle)."}),"\n",(0,n.jsx)(t.li,{children:"The contract cannot be canceled even if the Lender and Borrower agree without the cooperation of the Oracle entities."}),"\n",(0,n.jsx)(t.li,{children:"The complexity of the proposed solution and the fact that the security and business advantages may not be immediately apparent."}),"\n",(0,n.jsx)(t.li,{children:"The Lender must have some level of trust in the Liquidator (i.e. that they will return the funds after liquidating the bitcoin). This can be minimized, for example, by the Liquidator providing some form of security."}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>a});var i=r(6540);const n={},s=i.createContext(n);function o(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),i.createElement(s.Provider,{value:t},e.children)}}}]);