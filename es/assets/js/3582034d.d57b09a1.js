"use strict";(self.webpackChunkdocs_firefish=self.webpackChunkdocs_firefish||[]).push([[3470],{339:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"firefish-protocol","title":"Firefish Protocol","description":"This document outlines the technical design of the Firefish Protocol. Please note that the actual implementation\u2014delivered through Firefish platform\u2014may differ in certain aspects, as both the platform and the underlying escrow system remain under active development. For the most accurate and up-to-date information on the current functionality and limitations of the Firefish Protocol, please refer to the Terms of Service.","source":"@site/docs/firefish-protocol.md","sourceDirName":".","slug":"/firefish-protocol","permalink":"/docs-Firefish/es/docs/firefish-protocol","draft":false,"unlisted":false,"editUrl":"https://github.com/Anananas42/docs-Firefish/tree/main/docs/firefish-protocol.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"knowledgeHubSidebar","previous":{"title":"Loan Actions","permalink":"/docs-Firefish/es/docs/how-it-works/loan-actions-menu"},"next":{"title":"General","permalink":"/docs-Firefish/es/docs/faq/general"}}');var r=i(4848),s=i(8453);const o={sidebar_position:3},l="Firefish Protocol",a={},c=[{value:"Participants in Firefish Protocol",id:"participants-in-firefish-protocol",level:2},{value:"Loan outcomes",id:"loan-outcomes",level:2},{value:"Escrow Contract",id:"escrow-contract",level:2},{value:"Timelocks",id:"timelocks",level:3},{value:"Summary of closing transactions",id:"summary-of-closing-transactions",level:3},{value:"Prefund Contract",id:"prefund-contract",level:2},{value:"Protocol Implementation",id:"protocol-implementation",level:2},{value:"The Process",id:"the-process",level:2},{value:"Key Benefits of Firefish Protocol",id:"key-benefits-of-firefish-protocol",level:2},{value:"Potential Drawbacks of Firefish Protocol",id:"potential-drawbacks-of-firefish-protocol",level:2}];function d(e){const t={a:"a",blockquote:"blockquote",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"firefish-protocol",children:"Firefish Protocol"})}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsxs)(t.p,{children:["This document outlines the technical design of the Firefish Protocol. Please note that the actual implementation\u2014delivered through ",(0,r.jsx)(t.a,{href:"https://app.firefish.io",children:"Firefish platform"}),"\u2014may differ in certain aspects, as both the platform and the underlying escrow system remain under active development. For the most accurate and up-to-date information on the current functionality and limitations of the Firefish Protocol, please refer to the ",(0,r.jsx)(t.a,{href:"/docs/legal/terms-of-service",children:"Terms of Service"}),"."]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"participants-in-firefish-protocol",children:"Participants in Firefish Protocol"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Borrower:"})," An individual or entity that owns bitcoin and seeks fiat or stablecoins liquidity."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Lender:"})," An individual or entity that has excess fiat or stablecoins liquidity and wants to earn interest."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Liquidator:"})," An entity entrusted by the Lender to liquidate the collateral in its name in the event that the Borrower does not fulfill its obligations. The Lender can also act as the Liquidator themselves."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Price Oracle:"})," An Oracle that attests to the price of bitcoin. It can be implemented as a trusted institution, a public oracle, or a threshold of institutions and public oracles. Price Oracle is currently operated by Firefish."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Payment Oracle:"})," An Oracle that attests to whether or not a funds transfer has been made (e.g. loan repayment). Payment Oracle is currently operated by Firefish."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Firefish:"})," A platform that matches Borrowers and Lenders and facilitates their secure interaction."]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"loan-outcomes",children:"Loan outcomes"}),"\n",(0,r.jsx)(t.p,{children:"Below is a table of possible outcomes of the loan including (i) outcome defintion (Description), (ii) who decides that the outcome hapenned (Trigger), and (iii) what happens to bitcoin collateral for that outcome (Result)."}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{style:{textAlign:"left"},children:"Loan outcome"}),(0,r.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,r.jsx)(t.th,{style:{textAlign:"left"},children:"Result"}),(0,r.jsx)(t.th,{style:{textAlign:"left"},children:"Trigger"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Repayment"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Loan successfully repaid"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"All bitcoin collateral is returned to the Borrower"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Payment\u2011oracle"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Default"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Loan not successfully repaid"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Bitcoin collateral is sent to the Liquidator (distribution escrow). Part of the collateral is used to cover the amount due (either in Bitcoin for self\u2011managed liquidation or in loan currency for Firefish liquidation), the rest is returned back to Borrower"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Price\u2011oracle"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Liquidation"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Borrower\u2019s collateral does not fully secure the loan anymore due to the decrease in its value"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"All bitcoin collateral is sent to Lender (for self\u2011managed liquidation) or Liquidator (for Firefish liquidation)"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Price\u2011oracle and Payment\u2011oracle"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Cancellation"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Borrower locked bitcoin into escrow but Lender did not provide loan funds to the Borrower"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"All bitcoin collateral is returned to the Borrower"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Payment\u2011oracle"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Disaster"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Oracles are not responsive"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Borrower can rescue all bitcoin collateral from escrow one month after the maturity date via the recovery transaction"}),(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Borrower"})]})]})]}),"\n",(0,r.jsx)(t.h2,{id:"escrow-contract",children:"Escrow Contract"}),"\n",(0,r.jsx)(t.p,{children:"The escrow contract is a central part of the Firefish Protocol. It allows to lock bitcoin collateral on a specific multi-signature address and specifies the rules how this collateral can be spent."}),"\n",(0,r.jsxs)(t.p,{children:["The first layer of the escrow contract is the escrow transaction (tx",(0,r.jsx)("sub",{children:"escrow"}),"). Its input is the Borrower's bitcoin (via the Prefund transaction defined below) and its output is a 3-of-3 multisig, with keys held by:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"The Price Oracle"}),"\n",(0,r.jsx)(t.li,{children:"The Payment Oracle"}),"\n",(0,r.jsx)(t.li,{children:"The Borrower (Borrower's escrow key called B-EPH)"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"The output of the escrow transaction represents the escrow itself, and this is where the bitcoin is held during the loan."}),"\n",(0,r.jsx)(t.p,{children:"The second layer of the escrow contract is represented by a set of partially signed transactions (called closing transactions) spending bitcoin collateral from the escrow output either to Lender/Liquidator or Borrower, corresponding to possible outcomes of the loan. All these transactions are presigned by the Borrower (Borrower's escrow key B-EPH), whose private key is then discarded (that explains the name B-EPH, meaning that this key is only ephemeral). Discarding Borrower\u2019s private key ensures that these pre-signed transactions become the only way to move the bitcoin collateral from the escrow, effectively locking all parties into the agreed-upon rules."}),"\n",(0,r.jsx)(t.p,{children:"Besides being pre-signed by the Borrower, these closing transactions are pre-signed by the oracle that is not responsible for the corresponding loan outcome. Later, when some loan outcome happens, the responsible oracle confirms that by adding the last missing signature to the underlying closing transaction (making this transaction valid), and broadcasts this transaction to the bitcoin network."}),"\n",(0,r.jsx)(t.h3,{id:"timelocks",children:"Timelocks"}),"\n",(0,r.jsx)(t.p,{children:"Some closing transactions use timelocks, ensuring that these transactions can only be used from a specific date in the future. Concretely,"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"the closing transaction corresponding to Default has a timelock set to the maturity date, as a potential Default is evaluated not earlier than at the maturity date, and"}),"\n",(0,r.jsx)(t.li,{children:"the closing transaction corresponding to Disaster has a timelock set to one month after the maturity date, as an escrow is already spent at this time when oracles are responsive."}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"summary-of-closing-transactions",children:"Summary of closing transactions"}),"\n",(0,r.jsx)(t.p,{children:"There are at total five closing transactions:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{style:{textAlign:"left"},children:"Loan outcome"}),(0,r.jsx)(t.th,{style:{textAlign:"center"},children:"Closing transaction"}),(0,r.jsx)(t.th,{style:{textAlign:"center"},children:"Missing signature"}),(0,r.jsx)(t.th,{style:{textAlign:"center"},children:"Output to"}),(0,r.jsx)(t.th,{style:{textAlign:"center"},children:"Timelock"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Repayment"}),(0,r.jsxs)(t.td,{style:{textAlign:"center"},children:["tx",(0,r.jsx)("sub",{children:"repayment"})]}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Payment Oracle"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Borrower"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"-"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Default"}),(0,r.jsxs)(t.td,{style:{textAlign:"center"},children:["tx",(0,r.jsx)("sub",{children:"default"})]}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Payment Oracle"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Liquidator"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"maturity date"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Liquidation"}),(0,r.jsxs)(t.td,{style:{textAlign:"center"},children:["tx",(0,r.jsx)("sub",{children:"liquidation"})]}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Price Oracle, Payment Oracle"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Lender/Liquidator"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"-"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Cancellation"}),(0,r.jsxs)(t.td,{style:{textAlign:"center"},children:["tx",(0,r.jsx)("sub",{children:"repayment"})]}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Payment Oracle"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Borrower"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"-"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{style:{textAlign:"left"},children:"Disaster"}),(0,r.jsxs)(t.td,{style:{textAlign:"center"},children:["tx",(0,r.jsx)("sub",{children:"recover"})]}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"-"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"Borrower"}),(0,r.jsx)(t.td,{style:{textAlign:"center"},children:"maturity date + 1 month"})]})]})]}),"\n",(0,r.jsx)(t.p,{children:"The escrow contract can be schematically depicted as follows:"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Firefish protocol",src:i(5369).A+"",width:"2667",height:"1500"})}),"\n",(0,r.jsx)(t.h2,{id:"prefund-contract",children:"Prefund Contract"}),"\n",(0,r.jsx)(t.p,{children:"To make it practical for Borrowers who use a variety of bitcoin infrastructure (hardware wallets, software wallets, custodial wallets), we propose using an extra on-chain transaction to consolidate and acknowledge the UTXOs that will be used to fund the escrow contract."}),"\n",(0,r.jsxs)(t.p,{children:["This construct makes it easy for Borrowers to interact with the Firefish protocol. First, they send their bitcoin collateral to a specific prefund address (A",(0,r.jsx)("sub",{children:"prefund"}),"), which allows to create the follow-up escrow and closing transactions."]}),"\n",(0,r.jsx)(t.p,{children:"The prefund address represents the following spending condition:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"3-of-3 multisig (Borrower\u2019s prefund key, Price Oracle, Payment Oracle), or"}),"\n",(0,r.jsx)(t.li,{children:"Borrower\u2019s prefund key and a relative timelock of 7 days."}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"The first spending condition using the multisig is used to move bitcoin from prefund to escrow when all parties cooperate.\nThe second spending condition using only Borrower\u2019s prefund key with a relative timelock works as a safeguard for the Borrower, should oracles become unresponsive or malicious during the contract setup."}),"\n",(0,r.jsx)(t.p,{children:"Once the Bitcoin is locked into prefund, all information is known to create the escrow and closing transactions."}),"\n",(0,r.jsx)(t.p,{children:"The whole Firefish protocol, including prefund, escrow and closing transactions, can be schematically depicted as follows:"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Firefish protocol",src:i(3766).A+"",width:"2667",height:"1500"})}),"\n",(0,r.jsx)(t.h2,{id:"protocol-implementation",children:"Protocol Implementation"}),"\n",(0,r.jsxs)(t.p,{children:["The whole Firefish protocol is implemented in Rust. To simplify the interaction with the protocol for Borrowers, the Borrower's part, called borrower-client, is compiled into WASM and runs at ",(0,r.jsx)(t.a,{href:"https://app.firefish.io",children:"Firefish platform"}),". The source code for the borrower-client is available ",(0,r.jsx)(t.a,{href:"https://protocol.firefish.io",children:"here"}),". It also contains instructions for deterministic builds, allowing Borrowers to verify that the client used at Firefish platform corresponds to the published source code."]}),"\n",(0,r.jsx)(t.h2,{id:"the-process",children:"The Process"}),"\n",(0,r.jsx)(t.p,{children:"Below you can find the simplified process of the escrow setup and the lifetime of the loan."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"The participants in the protocol securely exchange necessary data (such as loan details) and public keys, everything via the Firefish platform."}),"\n",(0,r.jsx)(t.li,{children:"Borrower enters his return address where bitcoin collateral will be returned upon successful repayment."}),"\n",(0,r.jsx)(t.li,{children:"Using the borrower-client, the Borrower generates the prefund address."}),"\n",(0,r.jsx)(t.li,{children:"The Borrower sends bitcoin collateral to the prefund address using their own wallet."}),"\n",(0,r.jsx)(t.li,{children:"Using the borrower-client, the Borrower constructs the escrow and closing transactions, and adds their own signatures to the closing transactions."}),"\n",(0,r.jsx)(t.li,{children:"The oracles add their own signatures to the escrow transaction and the closing transactions according to the protocol specification."}),"\n",(0,r.jsx)(t.li,{children:"Using the borrower-client, the Borrower verifies that all transactions and signatures are in place. After verification, Borrower adds the last missing signature to the escrow transaction."}),"\n",(0,r.jsx)(t.li,{children:"Using the borrower-client, the Borrower discards their escrow private key, ensuring that the spending options for the escrow are limited to those defined by the closing transactions."}),"\n",(0,r.jsx)(t.li,{children:"Borrower broadcasts the now fully signed escrow transaction, effectively locking bitcoin collateral. The escrow is properly set."}),"\n",(0,r.jsx)(t.li,{children:"Lender sends funds (fiat or stablecoins) to the Borrower."}),"\n",(0,r.jsx)(t.li,{children:"Later, when the loan outcome is known (repayment, default, \u2026), the corresponding transaction is signed and broadcast by the responsible oracle for the given outcome, effectively closing the loan."}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"key-benefits-of-firefish-protocol",children:"Key Benefits of Firefish Protocol"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"The escrow has a \"deterministic\" nature. It can only be spent on the Borrower's or Lender\u2019s/Liquidator's address, but not to any other subject."}),"\n",(0,r.jsx)(t.li,{children:"The Lender does not need to possess any cryptographic material or otherwise interact with the Bitcoin network. This allows entities that are not Bitcoin-native to invest on the Firefish platform."}),"\n",(0,r.jsx)(t.li,{children:"The Borrower only needs to be online and interact with the platform during the escrow setup phase. Afterwards, this is no longer necessary - they do not need to sign anything else or keep the keys online."}),"\n",(0,r.jsx)(t.li,{children:"If the Oracles stop cooperating during any phase of the loan, the Borrower can spend the Bitcoin on their own address after the timelock expires."}),"\n",(0,r.jsx)(t.li,{children:"The interaction of the Borrower with the protocol is reduced to (i) provide your return address and (ii) send bitcoin to the prefund address. The whole complexity, such as creating the addresses and signing the escrow and closing transactions, is processed by the borrower-client."}),"\n",(0,r.jsx)(t.li,{children:"Since the interaction is so simple, Firefish can be used by hardware wallet owners as well as Multi-Party Computation (MPC) wallets (institutions) or even custodial solutions (which is indeed not recommended)."}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"potential-drawbacks-of-firefish-protocol",children:"Potential Drawbacks of Firefish Protocol"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"As with any other bitcoin-backed lending protocol, some level of trust is required in the oracles being honest. However, we believe that this need for trust can be minimized at the implementation level (for example, decentralizing the Price-oracle, using DLCs, anonymization techniques used by the Payment-oracle, etc.)."}),"\n",(0,r.jsx)(t.li,{children:"The contract cannot be canceled without the cooperation of the oracle entities, even if the Lender and Borrower agree."}),"\n",(0,r.jsx)(t.li,{children:"The complexity of the proposed solution and the fact that the security and business advantages may not be immediately apparent."}),"\n",(0,r.jsx)(t.li,{children:"The Lender (and Borrower) must have some level of trust in the Liquidator that they will return the funds/bitcoin in the case of liquidation and default. This can be minimized, for example, by the Liquidator providing some form of security or using DLCs."}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},3766:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/prefund_and_escrow-ebbe69fadc8ef08963e413204e39c5b3.png"},5369:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/escrow-153bc25284521d507a156c929ded35fe.png"},8453:(e,t,i)=>{i.d(t,{R:()=>o,x:()=>l});var n=i(6540);const r={},s=n.createContext(r);function o(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);